# -----------------------------------------------------------------------------
# Selenium Pytest CI Workflow (Updated - Clean Separation + Docker Caching)
# -----------------------------------------------------------------------------
# Description:
#   - Builds Docker image and starts Selenium Grid
#   - Runs Selenium tests and captures test result status
#   - Always uploads Allure results, screenshots, and HTML report
#   - Sends email notification at the end
#   - Docker layer caching enabled to reduce build/setup time
# -----------------------------------------------------------------------------

name: Selenium Pytest CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------------------
    # Step 1: Checkout Code
    # ----------------------------------------
    - name: Checkout Code
      uses: actions/checkout@v4

    # ----------------------------------------
    # Step 2: Set up Docker Compose
    # ----------------------------------------
    - name: Set up Docker Compose
      run: docker compose version

    # ----------------------------------------
    # Step 2.5: Cache Docker Layers
    # ----------------------------------------
    - name: Cache Docker Layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-docker-${{ github.sha }}

    # ----------------------------------------
    # Step 3: Build and Start Selenium Grid
    # ----------------------------------------
    - name: Build and Start Selenium Grid
      run: docker compose up -d

    # ----------------------------------------
    # Step 4: Wait for Docker Healthchecks
    # ----------------------------------------
    - name: Wait for Selenium Grid healthcheck
      run: |
        echo "‚è≥ Waiting for selenium-hub healthcheck..."
        RETRIES=12
        for i in $(seq 1 $RETRIES); do
          STATUS=$(docker inspect --format='{{json .State.Health.Status}}' selenium-hub || true)
          if [[ "$STATUS" == '"healthy"' ]]; then
            echo "‚úÖ Selenium Grid is healthy!"
            exit 0
          fi
          echo "üïí Attempt $i/$RETRIES: Grid health status = $STATUS. Retrying in 5s..."
          sleep 5
        done
        echo "‚ùå Selenium Grid did not become healthy in time."
        exit 1

    # ----------------------------------------
    # Step 5: Run Selenium Tests and Capture Exit Code
    # ----------------------------------------
    - name: Run Selenium Tests
      id: run_tests
      run: |
        echo "üöÄ Running Selenium tests..."
        set +e  # Don't fail pipeline on test failures
        docker compose exec tests pytest --alluredir=reports/allure-results
        TEST_EXIT_CODE=$?
        echo "Test Exit Code: $TEST_EXIT_CODE"
        echo "test_status=$TEST_EXIT_CODE" >> $GITHUB_ENV
        exit 0  # Always succeed here; we handle test failures separately

    # ----------------------------------------
    # Step 6.1: Install Allure CLI
    # ----------------------------------------
    - name: Install Allure CLI
      if: always()
      run: |
        echo "‚¨áÔ∏è Downloading Allure CLI..."
        curl -L -o allure-2.27.0.tgz https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
        tar -zxvf allure-2.27.0.tgz
        sudo mv allure-2.27.0 /opt/allure
        sudo ln -s /opt/allure/bin/allure /usr/bin/allure
        allure --version

    # ----------------------------------------
    # Step 6.2: Generate Allure HTML Report
    # ----------------------------------------
    - name: Generate Allure HTML Report
      if: always()
      run: |
        sudo mkdir -p reports/allure-report
        sudo allure generate reports/allure-results -o reports/allure-report --clean || echo "‚ö†Ô∏è Allure generation failed"

    # ----------------------------------------
    # Step 7: Upload Allure Results (Raw XML)
    # ----------------------------------------
    - name: Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: reports/allure-results/

    # ----------------------------------------
    # Step 8: Upload Allure HTML Report
    # ----------------------------------------
    - name: Upload Allure HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: reports/allure-report/

    # ----------------------------------------
    # Step 9: Upload Screenshots
    # ----------------------------------------
    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots
        path: reports/screenshots/

    # ----------------------------------------
    # Step 10: Send Email Notification with Test Status
    # ----------------------------------------
    - name: Send Email Notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: |
          Selenium Pytest CI - ${{ env.test_status == '0' && 'SUCCESS' || 'FAILURE' }}
        body: |
          Hi Reshma,

          The Selenium Pytest CI workflow has completed.
          ‚úÖ Build Status: SUCCESS
          üìä Test Status: ${{ env.test_status == '0' && 'PASSED' || 'FAILED' }}
          üì¶ Repository: ${{ github.repository }}
          üìù Workflow: ${{ github.workflow }}
          üîó Run URL: ${{ github.run_url }}

          üìÅ Artifacts Available:
          - Allure Results
          - Allure HTML Report
          - Screenshots

          Regards,
          GitHub Actions
        to: reshmasajeevpulickal@email.com
        from: ${{ secrets.EMAIL_USERNAME }}

    # ----------------------------------------
    # Step 11: Fail Job if Build Errors (Optional)
    # ----------------------------------------
    - name: Fail Job if Build Errors
      if: failure()
      run: exit 1
